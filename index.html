<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abidjan Nav Business Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        :root { --primary: #27ae60; --premium: #f1c40f; --dark: #1a1a1a; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; height: 100vh; overflow: hidden; }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: #fff; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI Elements */
        #map { position: absolute; inset: 0; z-index: 1; }
        .search-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 92%; z-index: 1000; }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        
        /* Publicit√© contextuelle */
        #adBox { display: none; background: #fff9e6; border: 1px dashed var(--premium); padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 13px; color: #856404; text-align: center; animation: slideDown 0.5s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Fiche Commer√ßant */
        #businessCard { display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; background: white; border-radius: 20px; padding: 15px; z-index: 2000; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); }
        .btn-wa { background: #25D366; color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; margin-top: 10px; text-decoration: none; display: block; text-align: center; }
        
        .badge-premium { background: var(--premium); color: #000; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        
        input, select { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 8px; font-size: 15px; box-sizing: border-box; }
        .btn-main { background: var(--dark); color: var(--premium); border: none; padding: 16px; border-radius: 10px; width: 100%; font-weight: 800; }
        
        .leaflet-routing-container { display: none !important; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p>Analyse de la zone...</p></div>

    <div class="search-container" id="uiSearch">
        <div class="card">
            <h3 style="margin:0 0 10px 0; font-size: 18px;">O√π souhaitez-vous aller ?</h3>
            <input type="text" id="searchName" placeholder="Ex: Pharmacie, Agence..." oninput="filtrerNoms()">
            <select id="categorie">
                <option value="">Toutes les cat√©gories</option>
                <option value="orange_money">Orange Money</option>
                <option value="pharmacie">Pharmacie</option>
                <option value="restaurant">Restaurant</option>
                <option value="banque">Banque</option>
            </select>
            <button class="btn-main" onclick="lancerStrategie()">TROUVER LE MEILLEUR SERVICE</button>
            <div id="adBox">‚ú® <b>Promo :</b> -15% chez notre partenaire √† proximit√© !</div>
        </div>
    </div>

    <div id="businessCard">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <span id="bizName" style="font-weight: 800; font-size: 18px;">Nom</span>
                <span id="bizBadge"></span>
                <div id="bizDist" style="color: var(--primary); font-weight: bold; font-size: 14px;">-- km ( -- min )</div>
            </div>
        </div>
        <a id="waLink" class="btn-wa" target="_blank">üí¨ COMMANDER VIA WHATSAPP</a>
    </div>

    <div id="map"></div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([5.3484, -4.0305], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let userPos = null, routingControl = null, tousLesLieux = [];

        async function chargerDonnees() {
            const resp = await fetch('./lieux.json');
            tousLesLieux = await resp.json();
        }
        chargerDonnees();

        function lancerStrategie() {
            document.getElementById('loader').style.display = 'flex';
            setTimeout(calculerProximiteBusiness, 1200);
        }

        function calculerProximiteBusiness() {
            const cat = document.getElementById('categorie').value;
            const search = document.getElementById('searchName').value.toLowerCase();

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userPos = [pos.coords.latitude, pos.coords.longitude];
                    
                    // STRAT√âGIE 1 : Filtrage avec Priorit√© Premium
                    let matches = tousLesLieux.filter(l => 
                        (cat === "" || l.cat === cat) && 
                        (search === "" || l.nom.toLowerCase().includes(search))
                    );

                    if (matches.length > 0) {
                        // On trie par distance, mais on fait remonter les Premium
                        matches.sort((a, b) => {
                            const distA = Math.hypot(a.lat - userPos[0], a.lng - userPos[1]);
                            const distB = Math.hypot(b.lat - userPos[0], b.lng - userPos[1]);
                            if (a.premium && !b.premium) return -1;
                            if (!a.premium && b.premium) return 1;
                            return distA - distB;
                        });

                        const cible = matches[0];
                        afficherBusiness(cible);
                    } else {
                        document.getElementById('loader').style.display = 'none';
                        alert("Aucun service trouv√©.");
                    }
                });
            }
        }

        function afficherBusiness(lieu) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('uiSearch').style.display = 'none';
            document.getElementById('businessCard').style.display = 'block';
            
            document.getElementById('bizName').innerText = lieu.nom;
            document.getElementById('bizBadge').innerHTML = lieu.premium ? '<span class="badge-premium">PREMIUM</span>' : '';
            
            // STRAT√âGIE 2 : Publicit√© Contextuelle
            if(lieu.premium) document.getElementById('adBox').style.display = 'block';

            // STRAT√âGIE 3 : Conversion (WhatsApp)
            document.getElementById('waLink').href = `https://wa.me/${lieu.phone || '22500000000'}?text=Bonjour, je vous ai trouv√© via l'application.`;

            // Itin√©raire
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(lieu.lat, lieu.lng)],
                createMarker: () => null, show: false,
                lineOptions: { styles: [{ color: '#27ae60', weight: 8 }] }
            }).on('routesfound', e => {
                const r = e.routes[0];
                document.getElementById('bizDist').innerText = `${(r.summary.totalDistance/1000).toFixed(1)} km (${Math.round(r.summary.totalTime/60)} min)`;
            }).addTo(map);
            map.setView(userPos, 15);
        }
    </script>
</body>
</html>
