<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abidjan Proximité</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { background: #2c3e50; color: white; padding: 15px; text-align: center; }
        #map { flex-grow: 1; width: 100%; }
        .ui-panel { padding: 15px; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); text-align: center; }
        
        select, button { 
            width: 90%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; 
        }
        button { background: #27ae60; color: white; font-weight: bold; border: none; cursor: pointer; }
        .leaflet-routing-container { display: none; }
    </style>
</head>
<body>

    <div id="header">ABIDJAN PROXIMITÉ</div>
    <div id="map"></div>

    <div class="ui-panel">
        <label>Que cherchez-vous ?</label>
        <select id="categorie">
            <option value="orange_money">Orange Money</option>
            <option value="pharmacie">Pharmacie</option>
            <option value="restaurant">Restaurant</option>
            <option value="banque">Banque</option>
            <option value="hopital">Hôpital</option>
        </select>
        <button onclick="trouverLePlusProche()">TROUVER LE PLUS PROCHE</button>
        <p id="info" style="font-size: 13px; color: #666;"></p>
    </div>

    <script>
        const map = L.map('map').setView([5.3484, -4.0305], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let tousLesLieux = []; // On commence avec une liste vide

// FONCTION POUR CHARGER LES DONNÉES
async function chargerDonnees() {
    try {
        const reponse = await fetch('lieux.json'); // On va chercher le fichier
        tousLesLieux = await reponse.json();      // On transforme le texte en liste utilisable
        console.log("Données chargées :", tousLesLieux.length, "lieux");
    } catch (erreur) {
        console.error("Erreur de chargement :", erreur);
    }
}

// Appeler le chargement dès le départ
chargerDonnees();

let routingControl = null;

async function trouverLePlusProche() {
    const choix = document.getElementById('categorie').value;
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const uLat = pos.coords.latitude;
            const uLng = pos.coords.longitude;

            // Filtrer parmi les lieux chargés du fichier JSON
            const listeFiltree = tousLesLieux.filter(l => l.cat === choix);

            if (listeFiltree.length === 0) {
                alert("Aucun résultat pour cette catégorie.");
                return;
            }

            let proche = listeFiltree[0];
            let minD = Infinity;

            listeFiltree.forEach(l => {
                const d = Math.hypot(l.lat - uLat, l.lng - uLng);
                if (d < minD) { minD = d; proche = l; }
            });

            // Tracer l'itinéraire (même logique qu'avant)
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(uLat, uLng), L.latLng(proche.lat, proche.lng)],
                lineOptions: { styles: [{ color: '#27ae60', weight: 6 }] },
                createMarker: function() { return null; }
            }).addTo(map);

            document.getElementById('info').innerText = "Cible : " + proche.nom;
        });
    }
}
    </script>
</body>
</html>