<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nav ProximitÃ© Abidjan - Stable</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f0f0; }
        #map { flex-grow: 1; width: 100%; }
        
        /* Panneau flottant d'infos */
        .info-nav { 
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 85%; background: white; padding: 12px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000;
            display: none; text-align: center; border-left: 5px solid #27ae60;
        }

        /* Bouton Centrer */
        .btn-center {
            position: absolute; bottom: 180px; right: 20px;
            background: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000; font-size: 20px; cursor: pointer;
        }

        .ui-panel { padding: 15px; background: #fff; border-radius: 20px 20px 0 0; margin-top: -20px; z-index: 1001; }
        .stats { display: flex; justify-content: space-around; font-weight: bold; font-size: 1.2em; color: #2c3e50; margin-top: 5px; }
        
        select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; }
        button.main-btn { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; }
        .leaflet-routing-container { display: none; }
    </style>
</head>
<body>

    <div class="info-nav" id="navPanel">
        <div id="destName" style="font-weight: bold; color: #27ae60;"></div>
        <div class="stats">
            <span id="kmRemaining">0 km</span>
            <span id="minRemaining">0 min</span>
        </div>
    </div>

    <div id="map"></div>

    <button class="btn-center" onclick="centrerCarte()">ðŸŽ¯</button>

    <div class="ui-panel">
        <select id="categorie">
            <option value="orange_money">Orange Money</option>
            <option value="pharmacie">Pharmacie</option>
            <option value="restaurant">Restaurant</option>
            <option value="banque">Banque</option>
        </select>
        <button class="main-btn" onclick="lancerRecherche()">TROUVER LE PLUS PROCHE</button>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([5.3484, -4.0305], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let userPos = null;
        let userMarker = L.circleMarker([0,0], { radius: 8, color: '#fff', fillColor: '#007bff', fillOpacity: 1, weight: 3 }).addTo(map);
        let destMarker = L.marker([0,0]).addTo(map);
        let routingControl = null;
        let watchID = null;
        let tousLesLieux = [];

        async function chargerDonnees() {
            try {
                const reponse = await fetch('./lieux.json');
                tousLesLieux = await reponse.json();
            } catch(e) { console.error("Erreur JSON"); }
        }
        chargerDonnees();

        function centrerCarte() {
            if (userPos) map.setView(userPos, 16);
        }

        function lancerRecherche() {
            // 1. Nettoyage de l'ancienne recherche
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            document.getElementById('navPanel').style.display = "none";

            if (navigator.geolocation) {
                // On arrÃªte l'ancienne surveillance si elle existe
                if (watchID) navigator.geolocation.clearWatch(watchID);

                watchID = navigator.geolocation.watchPosition(pos => {
                    userPos = [pos.coords.latitude, pos.coords.longitude];
                    userMarker.setLatLng(userPos);

                    const choix = document.getElementById('categorie').value;
                    const listeFiltree = tousLesLieux.filter(l => l.cat === choix);
                    
                    if(listeFiltree.length > 0) {
                        let proche = listeFiltree[0];
                        let minD = Infinity;
                        listeFiltree.forEach(l => {
                            const d = Math.hypot(l.lat - userPos[0], l.lng - userPos[1]);
                            if (d < minD) { minD = d; proche = l; }
                        });

                        destMarker.setLatLng([proche.lat, proche.lng]).bindPopup(proche.nom);
                        document.getElementById('destName').innerText = proche.nom;
                        document.getElementById('navPanel').style.display = "block";

                        // Mise Ã  jour itinÃ©raire
                        if (routingControl) map.removeControl(routingControl);
                        
                        routingControl = L.Routing.control({
                            waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(proche.lat, proche.lng)],
                            createMarker: () => null,
                            lineOptions: { styles: [{ color: '#27ae60', weight: 6, opacity: 0.8 }] },
                            addWaypoints: false,
                            draggableWaypoints: false
                        }).on('routesfound', function(e) {
                            const route = e.routes[0];
                            document.getElementById('kmRemaining').innerText = (route.summary.totalDistance / 1000).toFixed(1) + " km";
                            document.getElementById('minRemaining').innerText = Math.round(route.summary.totalTime / 60) + " min";
                        }).addTo(map);
                    }
                }, null, { enableHighAccuracy: true });
            }
        }
    </script>
</body>
</html>
