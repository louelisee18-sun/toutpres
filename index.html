<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abidjan Nav Business Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        :root { 
            --primary: #27ae60; 
            --premium: #f1c40f; 
            --dark: #1a1a1a; 
            --bg: #f8f9fa;
        }

        /* Empêche le défilement bizarre sur mobile */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: var(--bg);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Structure Flexible */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        /* Carte : prend tout l'espace disponible */
        #map { 
            flex: 1; 
            width: 100%;
            z-index: 1;
        }

        /* Barre d'infos en haut (toujours visible si active) */
        .top-info {
            position: absolute;
            top: 10px;
            left: 5%;
            width: 90%;
            z-index: 1000;
            display: none;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            text-align: center;
        }

        /* Panneau de recherche en bas */
        .bottom-panel {
            background: white;
            padding: 20px;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 1001;
            box-sizing: border-box;
        }

        /* Style des inputs Responsive */
        .input-group { margin-bottom: 10px; position: relative; }
        
        input, select {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #eee;
            background: #fdfdfd;
            font-size: 16px;
            box-sizing: border-box; /* Crucial pour le responsive */
            outline: none;
        }

        button.btn-main {
            width: 100%;
            padding: 16px;
            background: var(--dark);
            color: var(--premium);
            border: none;
            border-radius: 12px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* Fiche Business (Yango Style) */
        .business-card {
            display: none;
            padding: 15px;
            text-align: center;
        }

        .wa-button {
            display: block;
            background: #25D366;
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            margin-top: 10px;
        }

        /* SUPPRESSION DU BUG DE TA PHOTO */
        .leaflet-routing-container, .leaflet-routing-error {
            display: none !important;
            visibility: hidden !important;
        }

        /* Loader */
        #loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            z-index: 9999; display: none; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>Calcul de l'itinéraire...</p>
    </div>

    <div class="app-container">
        <div id="topNav" class="top-info">
            <b id="destTitle">Destination</b><br>
            <span id="routeStats" style="color:var(--primary); font-weight:bold;">-- km (-- min)</span>
        </div>

        <div id="map"></div>

        <div class="bottom-panel">
            <div id="searchForm">
                <div class="input-group">
                    <input type="text" id="searchName" placeholder="Nom du lieu..." oninput="filtrerNoms()">
                </div>
                <div class="input-group">
                    <select id="categorie">
                        <option value="">Toutes les catégories</option>
                        <option value="pharmacie">Pharmacie</option>
                        <option value="orange_money">Orange Money</option>
                        <option value="restaurant">Restaurant</option>
                    </select>
                </div>
                <button class="btn-main" onclick="lancerCalcul()">Lancer l'itinéraire</button>
            </div>

            <div id="bizResult" class="business-card">
                <h3 id="bizName" style="margin:0;">Nom du lieu</h3>
                <div id="bizTime" style="color:var(--primary); font-weight:bold; margin:5px 0;">-- min</div>
                <a id="waLink" href="#" class="wa-button">COMMANDER VIA WHATSAPP</a>
                <button onclick="location.reload()" style="background:none; border:none; color:gray; margin-top:10px; font-size:12px;">Nouvelle recherche</button>
            </div>
        </div>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([5.3484, -4.0305], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let userPos = null, routingControl = null, tousLesLieux = [];

        async function chargerDonnees() {
            try {
                const resp = await fetch('./lieux.json');
                tousLesLieux = await resp.json();
            } catch(e) { console.error("Fichier lieux.json introuvable"); }
        }
        chargerDonnees();

        function lancerCalcul() {
            document.getElementById('loader').style.display = 'flex';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userPos = [pos.coords.latitude, pos.coords.longitude];
                    trouverCible();
                }, () => { alert("Activez le GPS"); document.getElementById('loader').style.display='none'; });
            }
        }

        function trouverCible() {
            const cat = document.getElementById('categorie').value;
            const search = document.getElementById('searchName').value.toLowerCase();

            let matches = tousLesLieux.filter(l => 
                (cat === "" || l.cat === cat) && (search === "" || l.nom.toLowerCase().includes(search))
            );

            if (matches.length > 0) {
                // Tri par proximité
                matches.sort((a,b) => {
                    const dA = Math.hypot(a.lat - userPos[0], a.lng - userPos[1]);
                    const dB = Math.hypot(b.lat - userPos[0], b.lng - userPos[1]);
                    return dA - dB;
                });
                afficherTrajet(matches[0]);
            } else {
                alert("Rien trouvé");
                document.getElementById('loader').style.display='none';
            }
        }

        function afficherTrajet(lieu) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('searchForm').style.display = 'none';
            document.getElementById('bizResult').style.display = 'block';
            document.getElementById('topNav').style.display = 'block';
            
            document.getElementById('bizName').innerText = lieu.nom;
            document.getElementById('destTitle').innerText = lieu.nom;
            document.getElementById('waLink').href = `https://wa.me/${lieu.phone || '22500000000'}`;

            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(lieu.lat, lieu.lng)],
                createMarker: () => null,
                show: false,
                lineOptions: { styles: [{ color: '#27ae60', weight: 6 }] }
            }).on('routesfound', e => {
                const r = e.routes[0];
                const d = (r.summary.totalDistance/1000).toFixed(1) + " km";
                const t = Math.round(r.summary.totalTime/60) + " min";
                document.getElementById('routeStats').innerText = `${d} (${t})`;
                document.getElementById('bizTime').innerText = t;
            }).addTo(map);

            map.fitBounds([userPos, [lieu.lat, lieu.lng]], { padding: [50, 50] });
        }
    </script>
</body>
</html>
